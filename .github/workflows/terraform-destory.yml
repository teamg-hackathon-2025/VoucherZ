
name: Terraform Destroy (manual)

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  actions: write

concurrency:
  group: terraform-destroy
  cancel-in-progress: false

env:
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"
  AWS_REGION: ap-northeast-1
  TF_WORKING_DIR: "."

jobs:
  destroy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- å‰å›ã®ãƒ­ãƒƒã‚¯å–å¾— --- 
      - name: Download previous terraform lock
        run: |
          set +e  # ã‚¨ãƒ©ãƒ¼ã§æ­¢ã‚ãªã„
          echo "Attempting to download terraform lock..."
          gh run download --name terraform-lock --dir .terraform-lock --repo teamg-hackathon-2025/VoucherZ || echo "No previous lock found, continue."
        env:
          GH_TOKEN: ${{ github.token }}




      # --- ãƒ­ãƒƒã‚¯ç¢ºèª ---
      - name: Check Terraform lock
        run: |
          if [ ! -f .terraform-lock/main ]; then
            echo "No terraform lock found. Nothing to destroy."
            exit 1
          fi

      # --- OIDC & Terraform ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ---
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

       # state ã‚’å¾©å…ƒ
      - name: Download tfstate
        run: |
          gh run download --name terraform-tfstate --dir . --repo teamg-hackathon-2025/VoucherZ
        env:
          GH_TOKEN: ${{ github.token }}
 

      - name: Terraform Init
        run: terraform init

      - name: Terraform Rm State
        run: terraform state rm aws_service_discovery_private_dns_namespace.namespace

      - name: Terraform Destroy (auto-approve)
        run: terraform destroy -auto-approve

      # --- Remove lock file locally ---
      - name: Remove Terraform lock
        run: |
          gh api repos/teamg-hackathon-2025/VoucherZ/actions/artifacts \
          | jq -r '.artifacts[] | select(.name=="terraform-lock") | .id' \
          | xargs -I {} gh api --method DELETE repos/teamg-hackathon-2025/VoucherZ/actions/artifacts/{}
        env:
          GH_TOKEN: ${{ github.token }}
          
      # --- Remove lock file locally ---
      - name: Remove Terraform state
        run: |
          gh api repos/teamg-hackathon-2025/VoucherZ/actions/artifacts \
          | jq -r '.artifacts[] | select(.name=="terraform-tfstate") | .id' \
          | xargs -I {} gh api --method DELETE repos/teamg-hackathon-2025/VoucherZ/actions/artifacts/{}
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Notify Mattermost
        if: always()   # æˆå¦ã«é–¢ã‚ã‚‰ãšå®Ÿè¡Œ
        uses: mattermost/action-mattermost-notify@master
        with:
          MATTERMOST_WEBHOOK_URL: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
          TEXT: |
            ${{ job.status == 'success' && '**æœ¬ç•ªç’°å¢ƒãŒæ­£å¸¸ã«destoryã•ã‚Œã¾ã—ãŸï¼**ğŸš€ ' || '**æœ¬ç•ªç’°å¢ƒã®destoryã«å¤±æ•—ã—ã¾ã—ãŸã€‚**' }}
            - Workflow: **${{ github.workflow }}**
            - Branch: `${{ github.ref_name }}`
            - Actor: ${{ github.actor }}
            - Status: **${{ job.status }}**
            - [Run Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
