
name: Terraform Apply (on main)

on:
  #push:
    #    branches: [ "main" ] # mainãƒ–ãƒ©ãƒ³ãƒã«pushã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹

permissions:
  contents: read # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€æ¨©é™ï¼ˆactions/checkoutç”¨ï¼‰ã€‚runnerã«ã‚³ãƒ¼ãƒ‰ã‚’æŒã£ã¦ãã‚‹ãŸã‚ã«å¿…è¦
  id-token: write   # OIDC(OpenID Connect)ã§èªè¨¼ã™ã‚‹ãŸã‚ã«å¿…è¦ã€‚Jobsã‹ã‚‰id-tokenã‚’ç™ºè¡Œå¯èƒ½ã«ãªã‚‹ã€‚

concurrency: # åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã«å±ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒä¸¦åˆ—å®Ÿè¡Œã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ä»•çµ„ã¿ã€‚
  group: terraform-${{ github.ref_name }} # åˆ¶å¾¡å¯¾è±¡ã®ã‚°ãƒ«ãƒ¼ãƒ—åã€‚github.ref_nameã«ã¯ãƒ–ãƒ©ãƒ³ãƒåãŒå…¥ã‚‹ã€‚ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«æ‰€å±ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ä¸¦åˆ—å®Ÿè¡Œã•ã‚Œãªã„ã€‚
  cancel-in-progress: false # false: åŒã˜ãƒ–ãƒ©ãƒ³ãƒä¸Šã§ã¯æ–°ã—ã„ã‚¸ãƒ§ãƒ–ãŒå¾…æ©Ÿã—ã¦ã€å‰ã®ã‚¸ãƒ§ãƒ–ãŒçµ‚ã‚ã£ã¦ã‹ã‚‰å®Ÿè¡Œã€‚true: åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚¸ãƒ§ãƒ–ãŒæ–°ã—ãèµ°ã£ãŸã¨ãã€å¤ã„å®Ÿè¡Œä¸­ã®ã‚¸ãƒ§ãƒ–ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ã€‚

env:
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"
  TF_CLI_ARGS_init: "-input=false"
  TF_CLI_ARGS_apply: "-auto-approve"
  AWS_REGION: ap-northeast-1
  TF_WORKING_DIR: "."

jobs:
  apply:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

   
      # --- OIDC ---
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}   # ä¾‹: arn:aws:iam::123456789012:role/gh-oidc-terraform
          aws-region: ${{ env.AWS_REGION }}


      # --- ECR Docker Build & Push ---
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
        with:
          region: ${{ env.AWS_REGION }}

      - name: Build and Push voucherz-app image
        run: |
          docker build -t voucherz-app -f Dockerfile.app .
          docker tag voucherz-app:latest 715841364530.dkr.ecr.ap-northeast-1.amazonaws.com/voucherz-app:latest
          docker push 715841364530.dkr.ecr.ap-northeast-1.amazonaws.com/voucherz-app:latest

      - name: Build and Push voucherz-web image
        run: |
          docker build -t voucherz-web -f Dockerfile.web .
          docker tag voucherz-web:latest 715841364530.dkr.ecr.ap-northeast-1.amazonaws.com/voucherz-web:latest
          docker push 715841364530.dkr.ecr.ap-northeast-1.amazonaws.com/voucherz-web:latest

      # --- å‰å›ã®ãƒ­ãƒƒã‚¯å–å¾— --- 
      - name: Download previous terraform lock
        run: |
          set +e  # ã‚¨ãƒ©ãƒ¼ã§æ­¢ã‚ãªã„
          echo "Attempting to download terraform lock..."
          gh run download --name terraform-lock --dir .terraform-lock --repo teamg-hackathon-2025/VoucherZ || echo "No previous lock found, continue."
        env:
          GH_TOKEN: ${{ github.token }}

      # --- ãƒ­ãƒƒã‚¯ç¢ºèª ---
      - name: Check Terraform lock
        run: |
          if [ -f .terraform-lock/main ]; then
            echo "Terraform lock exists. Another apply/destroy is in progress."
            exit 1
          fi
      
      # --- ãƒ­ãƒƒã‚¯ä½œæˆ ---
      - name: Create Lock
        run: mkdir -p .terraform-lock && touch .terraform-lock/main
      
      # --- ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ---
      - name: Upload Lock artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-lock
          path: .terraform-lock/main
          retention-days: 15
 
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5


      - name: Terraform Init
        run: terraform init

      - name: Terraform Import
        run: terraform import aws_service_discovery_private_dns_namespace.namespace ns-2vzbb2e54ypnaxjf:vpc-05ffd3536a22a6d48


      - name: Terraform Validate
        run: terraform validate

          #      - name: Terraform Plan (for record)
          #        run: terraform plan

          #      - name: Upload plan artifact
          #        uses: actions/upload-artifact@v4
          #        with:
          #          name: tfplan-${{ github.sha }}
          #          path: ${{ env.TF_WORKING_DIR }}/tfplan
          #          if-no-files-found: warn
          #          retention-days: 7

      - name: Terraform Apply (auto-approve)
        run: terraform apply -auto-approve


      - name: Upload tfstate
        uses: actions/upload-artifact@v4
        with:
          name: terraform-tfstate
          path: terraform.tfstate
          retention-days: 15

      - name: Notify Mattermost
        if: always()   # æˆå¦ã«é–¢ã‚ã‚‰ãšå®Ÿè¡Œ
        uses: mattermost/action-mattermost-notify@master
        with:
          MATTERMOST_WEBHOOK_URL: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
          TEXT: |
            ${{ job.status == 'success' && '**[https://voucherz.jp](https://voucherz.jp)ã€€ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™**ğŸš€ ' || '**æœ¬ç•ªç’°å¢ƒã®æ§‹ç¯‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚**' }}
            - Workflow: **${{ github.workflow }}**
            - Branch: `${{ github.ref_name }}`
            - Actor: ${{ github.actor }}
            - Status: **${{ job.status }}**
            - [Run Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})  
